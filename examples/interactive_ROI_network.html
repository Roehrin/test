<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Interactive ROI Network</title>
    <link rel="stylesheet" href="../niivue.css" />
  </head>
  <body>
    <noscript>niivue requires JavaScript.</noscript>
    <header>
	<h2>Investigate the structural connectome</h2>
	<div class="dropdown">
        <button class="dropbtn">
          Edge Color
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn dropdown-item-checked"" id="!EdPlasma">Plasma</a>
          <a class="viewBtn" id="!EdViridis">Viridis</a>
          <a class="viewBtn" id="!EdInferno">Inferno</a>
		  <a class="viewBtn" id="!EdRandom">Random</a>
        </div>
    </div>
	<div class="dropdown">
        <button class="dropbtn">
          Node Color
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn dropdown-item-checked"" id="!NdPlasma">Plasma</a>
          <a class="viewBtn" id="!NdViridis">Viridis</a>
          <a class="viewBtn" id="!NdInferno">Inferno</a>
		  <a class="viewBtn" id="!NdRandom">Random</a>
        </div>
    </div>
  </header>
    <main id="container">
      <canvas id="gl1"></canvas>
    </main>
	<footer>
	<label for="edgeSlider">Edge Size</label>
    <input type="range" min="0" max="50" value="30" class="slider" id="edgeSlider" />
	<label for="EdThreshSlider">Edge Threshold</label>
    <input type="range" min="0" max="99" value="0" class="slider" id="EdThreshSlider" />
    <label for="nodeSlider">Node Size</label>
    <input type="range" min="0" max="150" value="30" class="slider" id="nodeSlider" />
    <label for="NdThreshSlider">Node Threshold</label>
    <input type="range" min="0" max="99" value="0" class="slider" id="NdThreshSlider" />
    <button id="reset">reset</button><br>
	<p>Select regions of interest<br>
	<label id="ROI_btns"></label>
	</footer>
  </body>
</html>
<script type="module" async>
  import * as niivue from "https://cdn.jsdelivr.net/npm/@niivue/niivue@0.46.0/dist/index.js";
  var volumeList1 = [
    {
      url: "https://niivue.github.io/niivue/images/mni152.nii.gz", 
      colormap: "gray",
      visible: true,
      opacity: 1
    }
  ];
  function toggleGroup(id) {
    let buttons = document.getElementsByClassName("viewBtn");
    let char0 = id.charAt(0);
    for (let i = 0; i < buttons.length; i++) {
      if (buttons[i].id.charAt(0) !== char0) continue;
      buttons[i].classList.remove("dropdown-item-checked");
      if (buttons[i].id === id)
        buttons[i].classList.add("dropdown-item-checked");
    }
  } // toggleGroup()
  async function onButtonClick(event) {
  if (event.target.id.charAt(0) === "!") {
      // set color scheme
      //nv1.volumes[0].colormap = cmaps[i];
	  if (event.target.id.startsWith("!Ed")){
		nv1.setMeshProperty(nv1.meshes[0].id, "edgeColormap", event.target.id.substr(3))
	  } else {https://niivue.github.io/niivue/devdocs/index.html
	    nv1.setMeshProperty(nv1.meshes[0].id, "nodeColormap", event.target.id.substr(3))
	  }
      toggleGroup(event.target.id);
      return;
    }
  }
  // Update the current slider value (each time you drag the slider handle)
  edgeSlider.oninput = function () {
    nv1.setMeshProperty(nv1.meshes[0].id, "edgeScale", this.value*.1)
  }
  nodeSlider.oninput = function () {
    nv1.setMeshProperty(nv1.meshes[0].id, "nodeScale", this.value*.1)
  }
  // Here we suppose that the node and edge values are normalised in [0 1]
  NdThreshSlider.oninput = function () {
    nv1.setMeshProperty(nv1.meshes[0].id, "nodeMinColor", this.value * .01)
  }
  EdThreshSlider.oninput = function () {
    nv1.setMeshProperty(nv1.meshes[0].id, "edgeMin", this.value * .01)
  }
  let opts = {
    show3Dcrosshair: true,
    isColorbar: true,
    backColor: [0, 0, 0, 1],
    //sliceType: niivue.SLICE_TYPE.RENDER,
	//multiplanarLayout: niivue.MULTIPLANAR_TYPE.GRID,
	multiplanarShowRender: niivue.SHOW_RENDER.ALWAYS,
	isOrientCube: true,
	showLegend: false,
	meshXRay: .3,
  }
  reset.onclick = function () {
    nv1.setDefaults(opts, true)
    nv1.setClipPlane([-0.0, 0, 40])
	nv1.setClipPlaneThick(1.73)
	nv1.volumes[0].colorbarVisible = false
  }
  var nv1 = new niivue.Niivue(opts);
  nv1.attachTo("gl1");
  await nv1.loadVolumes(volumeList1);
  await nv1.loadConnectomeFromUrl("https://roehrin.github.io/test/src/Lausanne2_ROI_n_SC.jcon");
  //   indexNearestXYZmm(Xmm: number, Ymm: number, Zmm: number): number[]  could be of interest
  // nv1.getAllLabels()
  nv1.setClipPlane([-0.0, 0, 40]);
  nv1.volumes[0].colorbarVisible = false
  //nv1.setMeshProperty(nv1.meshes[0].id, "legendLineThickness", 2)
  //let AllLbl = nv1.getAllLabels();
  //for (var i = 0; i < AllLbl.length; i++){
//	AllLbl[i].style.textScale = .5;
  //}
  nv1.setClipPlaneThick(1.73)
  nv1.updateGLVolume()
  let nodes = nv1.meshes[0].nodes;
  let ROI_btns = document.getElementById("ROI_btns");
  for (let i = 0; i < nodes.length; i++) {
	let btn = document.createElement("button");
		btn.innerHTML = nodes[i].name;
		btn.onclick = function () {
		
			let dPos = [nodes[i].x, nodes[i].y, nodes[i].z];
			dPos = nv1.volumes[0].mm2vox(dPos);
			const xhPos = nv1.frac2vox(nv1.scene.crosshairPos).slice(0, 3)
			//const xhPos = nv1.frac2mm([nv1.scene.crosshairPos[0], nv1.scene.crosshairPos[1], nv1.scene.crosshairPos[2]]).slice(0, 3);
			console.log(xhPos)
			for (let j = 0; j < dPos.length; j++){
			  dPos[j] = dPos[j] - xhPos[j];
			}
			//const vox = nv1.volumes[0].mm2vox(dPos);
			//console.log(vox)
			nv1.moveCrosshairInVox(dPos[0], dPos[1], dPos[2])
		};
	ROI_btns.appendChild(btn);
  }
  var buttons = document.getElementsByClassName("viewBtn");
  for (let i = 0; i < buttons.length; i++)
    buttons[i].addEventListener("click", onButtonClick, false);
</script>