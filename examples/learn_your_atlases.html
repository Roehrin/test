<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Minimal User Interface</title>
    <link rel="stylesheet" href="https://niivue.github.io/niivue/features/niivue.css" />
  </head>
  <body>
    <header>
      <div class="dropdown">
        <button class="dropbtn">
          File
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="SaveBitmap">Screen Shot</a>
          <a class="viewBtn" id="ShowHeader">Show Header</a>
          <a class="linker" href="https://github.com/niivue/niivue">About</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn" data-toggle="dropdown">
          View
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a href="#" class="viewBtn" id="|Axial">Axial</a>
          <a class="viewBtn" id="|Sagittal">Sagittal</a>
          <a class="viewBtn" id="|Coronal">Coronal</a>
          <a class="viewBtn" id="|Render">Render</a>
          <a class="viewBtn" id="|MultiPlanar">A+C+S</a>
          <a class="viewBtn dropdown-item-checked" id="|MultiPlanarRender"
            >A+C+S+R</a
          >
          <a class="viewBtn divider" id="Radiological">Radiological</a>
          <a class="viewBtn dropdown-item-checked" id="Crosshair"
            >Render Crosshair</a
          >
          <a class="viewBtn" id="ClipPlane">Render Clip Plane</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">
          Script
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
		  <a class="viewBtn dropdown-item-checked" id="_AAL">AAL</a>
          <a class="viewBtn" id="_Lausanne1">Lausanne1</a>
          <a class="viewBtn" id="_Lausanne2">Lausanne2</a>
        </div>
      </div>
    </header>
    <main id="container">
      <canvas id="gl1"></canvas>
    </main>
    <footer id="locationx"><span id="hover"></span>&nbsp;<span id="location"></span></footer>
  </body>
</html>
<script type="module" async>
  import * as niivue from "https://cdn.jsdelivr.net/npm/@niivue/niivue@0.46.0/dist/index.js";
  
  const isTouchDevice =
    "ontouchstart" in window ||
    navigator.maxTouchPoints > 0 ||
    navigator.msMaxTouchPoints > 0;
  function handleLocationChange(data) {
        document.getElementById("location").innerHTML = "-".repeat(10) + ' Clicked: '+  cmap.labels[data.values[0].value]
  }
  var nv1 = new niivue.Niivue({
    logging: true,
    dragAndDropEnabled: false,
    // backColor: [0, 0, 0, 1],
    show3Dcrosshair: true,
    onLocationChange: handleLocationChange,
  });
  nv1.opts.isColorbar = false;
  nv1.setRadiologicalConvention(false);
  nv1.attachTo("gl1");
  nv1.setClipPlane([0.3, 270, 0]);
  nv1.setRenderAzimuthElevation(120, 10);
  nv1.setSliceType(nv1.sliceTypeMultiplanar);
  nv1.setSliceMM(true);
  nv1.opts.isOrientCube = true;
  nv1.opts.multiplanarShowRender = niivue.SHOW_RENDER.ALWAYS;
  nv1.graph.autoSizeMultiplanar = true;
  nv1.graph.opacity = 1.0;
  var volumeList1 = [{ url: "https://niivue.github.io/niivue/images/aal.nii.gz"},{ url: "https://niivue.github.io/niivue/images/aal.nii.gz"}];
  await nv1.loadVolumes(volumeList1);
  async function fetchJSON(fnm) {
        const response = await fetch(fnm)
        const js = await response.json()
        return js
      }
  var cmap = await fetchJSON("https://niivue.github.io/niivue/images/aal.json")
  nv1.volumes[0].setColormapLabel(cmap)
  var opacity_lvl = 120/255
  nv1.setOpacity(0, opacity_lvl)
  nv1.volumes[1].setColormapLabel(cmap)
  nv1.setInterpolation(true) // nearest neighbour interp because of the atlases
  let clut = nv1.volumes[1].colormapLabel.lut
      //make all regions translucent
  for (let a = 3+4; a < clut.length ; a += 4) {
        clut[a] = 0
  }
  nv1.updateGLVolume()
  function toggleGroup(id) {
    let buttons = document.getElementsByClassName("viewBtn");
    let char0 = id.charAt(0);
    for (let i = 0; i < buttons.length; i++) {
      if (buttons[i].id.charAt(0) !== char0) continue;
      buttons[i].classList.remove("dropdown-item-checked");
      if (buttons[i].id === id)
        buttons[i].classList.add("dropdown-item-checked");
    }
  } // toggleGroup()
  async function onButtonClick(event) {
    if (isTouchDevice) {
      console.log("Touch device: click menu to close menu");
      /*var el = this.parentNode
        el.style.display = "none"
        setTimeout(function() { //close menu
          //el.style.removeProperty("display")
          //el.style.display = "block"
        }, 500)*/
    }
    if (event.target.id === "SaveBitmap") {
      nv1.saveScene("ScreenShot.png");
      return;
    }
    if (event.target.id === "ShowHeader") {
      alert(nv1.volumes[0].hdr.toFormattedString());
      return;
    }
    if (event.target.id === "Radiological") {
      nv1.opts.isRadiologicalConvention = !nv1.opts.isRadiologicalConvention;
      event.srcElement.classList.toggle("dropdown-item-checked");
      nv1.drawScene();
      return;
    }
    if (event.target.id === "Crosshair") {
      nv1.opts.show3Dcrosshair = !nv1.opts.show3Dcrosshair;
      event.srcElement.classList.toggle("dropdown-item-checked");
      nv1.drawScene();
    }
    if (event.target.id === "ClipPlane") {
      if (nv1.scene.clipPlaneDepthAziElev[0] > 1)
        nv1.setClipPlane([0.3, 270, 0]);
      else nv1.setClipPlane([2, 270, 0]);
      nv1.drawScene();
      return;
    }
    if (event.target.id.charAt(0) === "!") {
      // set color scheme
      //nv1.volumes[0].colormap = cmaps[i];
      nv1.volumes[0].colormap = event.target.id.substr(1);
      nv1.updateGLVolume();
      toggleGroup(event.target.id);
      return;
    }
    if (event.target.id.charAt(0) === "|") {
      //sliceType
      if (event.target.id === "|Axial") nv1.setSliceType(nv1.sliceTypeAxial);
      if (event.target.id === "|Coronal")
        nv1.setSliceType(nv1.sliceTypeCoronal);
      if (event.target.id === "|Sagittal")
        nv1.setSliceType(nv1.sliceTypeSagittal);
      if (event.target.id === "|Render") nv1.setSliceType(nv1.sliceTypeRender);
      if (event.target.id === "|MultiPlanar") {
        nv1.opts.multiplanarShowRender = niivue.SHOW_RENDER.NEVER;
        nv1.setSliceType(nv1.sliceTypeMultiplanar);
      }
      if (event.target.id === "|MultiPlanarRender") {
        nv1.opts.multiplanarShowRender = niivue.SHOW_RENDER.ALWAYS;
        nv1.setSliceType(nv1.sliceTypeMultiplanar);
      }
      toggleGroup(event.target.id);
    } //sliceType
    if (event.target.id === "BackColor") {
      if (nv1.opts.backColor[0] < 0.5) nv1.opts.backColor = [1, 1, 1, 1];
      else nv1.opts.backColor = [0, 0, 0, 1];
      nv1.drawScene();
      event.srcElement.classList.toggle("dropdown-item-checked");
      return;
    }
	// Load atlases
	// Lausanne scales are redundant so could optimise the code here
	if (event.target.id.startsWith("_Lausanne")) {
		let root = "https://roehrin.github.io/test/src/sub-template_atlas-L2018_res-scale";
		let ending_MR = "_dseg.nii.gz";
		let ending_LUT = "_FreeSurferColorLUT.json";
		let MR_fname = root + event.target.id.slice(-1) + ending_MR;
		let LUT_fname = root + event.target.id.slice(-1) + ending_LUT;
		volumeList1[0].url = MR_fname;
		volumeList1[1].url = MR_fname;
		cmap = await fetchJSON(LUT_fname)
		//clut = nv1.volumes[1].colormapLabel.lut
		await nv1.loadVolumes(volumeList1);
		nv1.volumes[0].setColormapLabel(cmap)
		nv1.volumes[1].setColormapLabel(cmap)
		nv1.setOpacity(0, opacity_lvl)
		toggleGroup(event.target.id);
		nv1.updateGLVolume();
    } else if (event.target.id === "_AAL") {
      volumeList1[0].url = "https://niivue.github.io/niivue/images/aal.nii.gz";
	  volumeList1[1].url = "https://niivue.github.io/niivue/images/aal.nii.gz";
      cmap = await fetchJSON("https://niivue.github.io/niivue/images/aal.json")
	  await nv1.loadVolumes(volumeList1);
	  nv1.volumes[0].setColormapLabel(cmap);
	  nv1.volumes[1].setColormapLabel(cmap)
	  nv1.setOpacity(0, opacity_lvl)
      nv1.updateGLVolume();
    } //example image
  } // onButtonClick()
  var buttons = document.getElementsByClassName("viewBtn");
  for (let i = 0; i < buttons.length; i++)
  buttons[i].addEventListener("click", onButtonClick, false);
  // handle hover on the atlases
  let activeIdx = - 1
  gl1.addEventListener("mousemove", (e) => {
	let pos = nv1.getNoPaddingNoBorderCanvasRelativeMousePosition(e, nv1.gl.canvas)
	const frac = nv1.canvasPos2frac([pos.x  * nv1.uiData.dpr, pos.y  * nv1.uiData.dpr])
	if (frac[0] >= 0) {
		let mm = nv1.frac2mm(frac)
		//console.log(mm[0])
		const vox = nv1.volumes[1].mm2vox(mm)
		let idx = nv1.volumes[1].getValue(vox[0], vox[1], vox[2])
		if ((isFinite(idx)) && (idx !== activeIdx)) {
			document.getElementById("hover").innerHTML = 'Hover: '+ nv1.volumes[1].colormapLabel.labels[idx]
			if (idx > 0){
				activeIdx = idx
				let lut = clut.slice() //nv1.volumes[1].colormapLabel.lut
				lut[(idx * 4)+3] = 255
				nv1.volumes[1].colormapLabel.lut = lut.slice()
				nv1.updateGLVolume()
			}
			
		}	
	}
  })
</script>
