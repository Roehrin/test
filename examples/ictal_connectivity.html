<!DOCTYPE html>
<html lang="en">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Connectivity during seizure recorded by iEEG.</title>
    <link rel="stylesheet" href="../niivue_dualview.css" />
  </head>
  <body>
    <noscript>niivue requires JavaScript.</noscript>
    <header>
	<h3>Connectivity during seizure recorded by iEEG.</h3>
	<div class="dropdown" id='dropDownMenu'>
		<button class="dropbtn" data-toggle="dropdown">
		  View
		  <i class="fa fa-caret-down"></i>
		</button>
		<div class="dropdown-content">
		  <a href="#" class="viewBtn" id="|Axial">Axial</a>
		  <a class="viewBtn" id="|Sagittal">Sagittal</a>
		  <a class="viewBtn" id="|Coronal">Coronal</a>
		  <a class="viewBtn" id="|Render">Render</a>
		  <a class="viewBtn" id="|MultiPlanar">A+C+S</a>
		  <a class="viewBtn dropdown-item-checked" id="|MultiPlanarRender">A+C+S+R</a>
		  <a class="viewBtn divider dropdown-item-checked" id="Colorbar">Colorbar</a>
		  <a class="viewBtn" id="Radiological">Radiological</a>
		  <a class="viewBtn" id="ClipPlane">Render Clip Plane</a>
		</div>
    </div>
	<div class="dropdown">
        <button class="dropbtn">
          Edge Color
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn" id="!EdPlasma">Plasma</a>
          <a class="viewBtn" id="!EdViridis">Viridis</a>
          <a class="viewBtn dropdown-item-checked" id="!EdInferno">Inferno</a>
		  <a class="viewBtn" id="!EdRandom">Random</a>
        </div>
    </div>
	<div class="dropdown">
        <button class="dropbtn">
          Node Color
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn dropdown-item-checked" id="!NdPlasma">Plasma</a>
          <a class="viewBtn" id="!NdViridis">Viridis</a>
          <a class="viewBtn" id="!NdInferno">Inferno</a>
		  <a class="viewBtn" id="!NdRandom">Random</a>
        </div>
    </div>
	<div class="dropdown">
        <button class="dropbtn">
          Connectivity
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn dropdown-item-checked" id="_PLV">PLV</a> 
          <a class="viewBtn" id="_coh">coherence</a> 
		  <a class="viewBtn" id="_env">envelope correlation</a> 
        </div>
    </div>
	<div class="dropdown">
        <button class="dropbtn">
          Frequency band
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn dropdown-item-checked" id="+delta">delta</a> 
          <a class="viewBtn" id="+theta">theta</a> 
		  <a class="viewBtn" id="+alpha">alpha</a> 
		  <a class="viewBtn" id="+beta">beta</a> 
		  <a class="viewBtn" id="+gamma">gamma</a> 
        </div>
    </div>
	<div class="dropdown">
        <button class="dropbtn">
          Network measure
          <i class="fa fa-caret-down"></i>
        </button>
        <div class="dropdown-content">
          <a class="viewBtn dropdown-item-checked" id="?strength">strength</a>
        </div>
    </div>
	<div class="dropdown">
			<button class="dropbtn">
			  About
			  <i class="fa fa-caret-down"></i>
			</button>
			<div class="dropdown-content">
				<a class="viewBtn dropdown" id="-Help">Help</a>
				<a class="viewBtn dropdown" id="-Authors">Authors</a>
				<a class="viewBtn dropdown" href="https://github.com/niivue/niivue" target="_blank">Niivue</a>
				<a class="viewBtn dropdown" href="https://plotly.com/javascript/" target="_blank">Plotly</a>
			</div>
		</div>
  </header>
		<div class="page-wrapper">
			<div class="row">
				<div class="column">
						<div id="seizureTraces" style="height:700px">
						</div>
				</div>
				<div class="column">
					<canvas id="gl1"></canvas>
				</div>
			</div>
		</div>
	</div>
  <footer>
	<label for="edgeSlider">Edge Size</label>
    <input type="range" min="0" max="100" value="30" class="slider" id="edgeSlider" />
	<label for="EdThreshSlider">Edge Threshold</label>
    <input type="range" min="0" max="99" value="0" class="slider" id="EdThreshSlider" />
    <label for="nodeSlider">Node Size</label>
    <input type="range" min="0" max="150" value="30" class="slider" id="nodeSlider" />
    <label for="NdThreshSlider">Node Threshold</label>
    <input type="range" min="0" max="99" value="0" class="slider" id="NdThreshSlider" />
    <button id="reset">reset</button>
  </footer>
  </body>
</html>
<script type="module" async>
  import * as niivue from "https://cdn.jsdelivr.net/npm/@niivue/niivue@0.46.0/dist/index.js";
  import * as vhdrReader from 'https://roehrin.github.io/test/js-scripts/brainvisionReader.js';
  async function onButtonClick(event) {
	  if (event.target.id.charAt(0) === "|") {
		  //sliceType
		  if (event.target.id === "|Axial") nv1.setSliceType(nv1.sliceTypeAxial);
		  if (event.target.id === "|Coronal")
			nv1.setSliceType(nv1.sliceTypeCoronal);
		  if (event.target.id === "|Sagittal")
			nv1.setSliceType(nv1.sliceTypeSagittal);
		  if (event.target.id === "|Render") nv1.setSliceType(nv1.sliceTypeRender);
		  if (event.target.id === "|MultiPlanar") {
			nv1.opts.multiplanarShowRender = niivue.SHOW_RENDER.NEVER;
			nv1.setSliceType(nv1.sliceTypeMultiplanar);
		  }
		  if (event.target.id === "|MultiPlanarRender") {
			nv1.opts.multiplanarShowRender = niivue.SHOW_RENDER.ALWAYS;
			nv1.setSliceType(nv1.sliceTypeMultiplanar);
		  }
		  toggleGroup(event.target.id);
	  } //sliceType
	  if (event.target.id === "Colorbar") {
		  nv1.opts.isColorbar = !nv1.opts.isColorbar;
		  event.srcElement.classList.toggle("dropdown-item-checked");
		  nv1.drawScene();
		  return;
		}
	  if (event.target.id === "Radiological") {
		  nv1.opts.isRadiologicalConvention = !nv1.opts.isRadiologicalConvention;
		  event.srcElement.classList.toggle("dropdown-item-checked");
		  nv1.drawScene();
		  return;
		}
	  if (event.target.id === "ClipPlane") {
		  if (nv1.scene.clipPlaneDepthAziElev[0] > 1)
			nv1.setClipPlane([0.3, 270, 0]);
		  else nv1.setClipPlane([2, 270, 0]);
		  nv1.drawScene();
		  return;
		}
	  if (event.target.id.charAt(0) === "!") {
		  // set color scheme
		  //nv1.volumes[0].colormap = cmaps[i];
		  if (event.target.id.startsWith("!Ed")){
			EdColormap = event.target.id.substr(3);
			for (let idMesh=0; idMesh<nv1.meshes.length;  idMesh++)
			nv1.setMeshProperty(nv1.meshes[idMesh].id, "edgeColormap", EdColormap);
			//currCScale = convertMapperclut2Colorscale();
			//data[0].colorscale = currCScale;
			//Plotly.redraw('matrixDiv');
		  } else {
			NdColormap = event.target.id.substr(3);
			for (let idMesh=0; idMesh<nv1.meshes.length;  idMesh++)
			nv1.setMeshProperty(nv1.meshes[idMesh].id, "nodeColormap", NdColormap)
		  }
		  toggleGroup(event.target.id);
		  return;
		}
	  if (event.target.id.charAt(0) === "_") {
			// turn off current heatmap
			Plotly.restyle(seizureTraces, {'opacity': 0, 'showscale':false}, currConn*freqList.length + currFreqId);
			currConn = ["_PLV", "_coh", "_env"].indexOf(event.target.id);
			Plotly.restyle(seizureTraces, {'opacity': 1, 'showscale':true}, currConn*freqList.length + currFreqId);
			toggleGroup(event.target.id);
			return
		}
	  if (event.target.id.charAt(0) === "+") {
			// turn off current heatmap
			Plotly.restyle(seizureTraces, {'opacity': 0, 'showscale':false}, currConn*freqList.length + currFreqId);
			currFreqId = freqList.indexOf(event.target.id.substr(1));
			Plotly.restyle(seizureTraces, {'opacity': 1, 'showscale':true}, currConn*freqList.length + currFreqId);
			toggleGroup(event.target.id);
			return
		}
	  if (event.target.id.charAt(0) === "-") {
			if (event.target.id.substr(1) == "Help"){
				alert("Naviguate the structural connectome.\nHover on the matrix will highlight the region (or node) on the y axis.\n\n" + 
				"One click will show this region on the MRI.\nA second on the same region will show only the neighbourhood of this region.\n" + 
				"Another click will reset the view.\n\n" + 
				"The edge and node size sliders allow you to change the size of the nodes and edges of the graph displayed on the MRI.\n" + 
				"The edge and node threshold sliders allow you to set a threshold below which the node or edges are not displayed (on the MRI and matrix).\n");
			} else if (event.target.id.substr(1) == "Authors"){
				alert("The data were curated and selected by Dr Stanislas Lagarde.\nThe data were processed by Dr Nicolas Roehri, using Fieldtrip.\nThe webpage was written by Dr Nicolas Roehri, using Niivue and Plotly.");
			}
		}	
  }
	
  const fileUrl = "https://roehrin.github.io/test/ictal_connectivity/seizure1.eeg";
  const hdr = await vhdrReader.readVHDRfromURL(fileUrl.replace(".eeg", ".vhdr"));
  const iEEGdata = await vhdrReader.readBrainvisionEEGData(fileUrl,hdr, 0.0064/2, true);
  const freqList = ['delta', 'theta', 'alpha', 'beta', 'gamma'];
  var PLV = [];
  var coh = [];
  var envCorr = [];
  var currFreqId = 0;
  var currConn = 0;
  var EdColormap = "Inferno";
  var NdColormap = "Plasma";
  
  for (let idFreq = 0; idFreq < freqList.length; idFreq++){
		let response = await fetch("https://roehrin.github.io/test/ictal_connectivity/connectivity_" + freqList[idFreq] + ".json", {})
		let connectivity = await response.json()
		let currPLV = {
			x: connectivity.PLV.t,
			z: connectivity.PLV.strength,
			type: 'heatmap',
			colorscale: 'YlOrRd',
			zmin:0,
			opacity:0,
			showscale: false,
		};
		PLV.push(currPLV)
		let currcoh = {
			x: connectivity.coh.t,
			z: connectivity.coh.strength,
			type: 'heatmap',
			colorscale: 'YlOrRd',
			showscale: false,
			zmin:0,
			opacity:0,
		};
		coh.push(currcoh)
		let currEnvCorr = {
			x: connectivity.envCorr.t,
			z: connectivity.envCorr.strength,
			type: 'heatmap',
			colorscale: 'YlOrRd',
			zmin:0,
			opacity:0,
			showscale: false,
		};
		envCorr.push(currEnvCorr)
  }
  
  PLV.push(...coh, ...envCorr, ...iEEGdata)
  var layout = {
      hovermode:'closest',
	  xaxis: {
		  title: {
			text: 'Time [s]'
		  },
		  showgrid: true,
		  automargin: true,
		  tickfont: { size: 14}
	  },
	  autosize: true,
	  margin: {
		l: 2,
		r: 2,
		b: 50,
		t: 2,
		//pad: 4
	  },
	  yaxis: {
		  visible: false,
		  automargin: true,
		  //tickfont: { size: 14}
	  },
	  showlegend: false
	};
	var config = {responsive: true};
	Plotly.newPlot('seizureTraces', PLV, layout, config);
	// update line width to 1
	Plotly.restyle(seizureTraces, {'line.width': 1});
	// too slow
	//seizureTraces.on('plotly_hover', function(data){
	//	let chnID = data.points[0].curveNumber;
	//	Plotly.restyle(seizureTraces, {'line.width': 3}, chnID);
	//});
	//seizureTraces.on('plotly_unhover', function(data){
	//let chnID = data.points[0].curveNumber;
	//	Plotly.restyle(seizureTraces, {'line.width': 1},chnID);
	//});
  var volumeList1 = [
    {
      url: "https://roehrin.github.io/test/ictal_connectivity/patient_mri.nii", 
      colormap: "gray",
      visible: true,
      opacity: 1
    }
  ];
  let opts = {
    show3Dcrosshair: true,
    isColorbar: true,
	//isResizeCanvas: false,
    backColor: [0, 0, 0, 1],
	dragAndDropEnabled: false,
    //sliceType: niivue.SLICE_TYPE.RENDER,
	multiplanarLayout: niivue.MULTIPLANAR_TYPE.GRID,
	multiplanarShowRender: niivue.SHOW_RENDER.ALWAYS,
	isOrientCube: true,
	showLegend: false,
	meshXRay: .3,
  }
  var nv1 = new niivue.Niivue(opts);
  nv1.attachTo("gl1");
  await nv1.loadVolumes(volumeList1);
  nv1.setClipPlane([-0.0, 0, 40]);
  //thickness of slab. Value 0..1.73 (cube opposite corner length is sqrt(3)).
  nv1.setClipPlaneThick(1.73)
  nv1.opts.multiplanarShowRender = niivue.SHOW_RENDER.ALWAYS;
  nv1.opts.isColorbar = true;
  nv1.opts.isOrientCube = true;
  await nv1.loadConnectomeFromUrl("https://roehrin.github.io/test/ictal_connectivity/pat_elec.jcon");
  nv1.opts.showLegend = false;
  nv1.meshes[0].edgeColormapNegative = '';
  nv1.updateGLVolume()
  Plotly.restyle(seizureTraces, {'opacity': 1, 'showscale':true}, 0);
  
  var buttons = document.getElementsByClassName("viewBtn");
  for (let i = 0; i < buttons.length; i++){
	buttons[i].addEventListener("click", onButtonClick, false);
  }
  function toggleGroup(id) {
    let buttons = document.getElementsByClassName("viewBtn");
    let char0 = id.charAt(0);
	let char03 = id.slice(0,3);
    for (let i = 0; i < buttons.length; i++) {
	  if (buttons[i].id.charAt(0) !== char0) continue;
	  if ((char03 === "!Ed" || char03 === "!Nd") && (buttons[i].id.slice(0,3) !== char03)) continue;
	  buttons[i].classList.remove("dropdown-item-checked");
	  if (buttons[i].id === id)
		buttons[i].classList.add("dropdown-item-checked");
    }
  } // toggleGroup()
</script>